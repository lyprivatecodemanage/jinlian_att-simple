<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xiangshangban.att_simple.dao.AlgorithMapper">
  <resultMap id="ClassesEmployee" type="com.xiangshangban.att_simple.bean.ClassesEmployee">
    <result column="emp_id" jdbcType="VARCHAR" property="empId" />
    <result column="emp_company_id" jdbcType="VARCHAR" property="empCompanyId" />
    <result column="classes_id" jdbcType="VARCHAR" property="classesId" />
    <result column="on_duty_scheduling_date" jdbcType="VARCHAR" property="onDutySchedulingDate" />
    <result column="off_duty_scheduling_date" jdbcType="VARCHAR" property="offDutySchedulingDate" />
    <result column="rest_start_time" property="restStartTime"/>
    <result column="rest_end_time" property="restEndTime"/>
    <result column="week" jdbcType="VARCHAR" property="week" />
    <result column="sign_in_rule" jdbcType="VARCHAR" property="signInRule" />
    <result column="sign_out_rule" jdbcType="VARCHAR" property="signOutRule" />
    <result column="on_punch_card_time" jdbcType="VARCHAR" property="onPunchCardTime" />
    <result column="off_punch_card_time" jdbcType="VARCHAR" property="offPunchCardTime" />
  </resultMap>
  <resultMap id="ClassesMap" type="com.xiangshangban.att_simple.bean.ClassesType">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="classes_name" jdbcType="VARCHAR" property="classesName" />
    <result column="on_duty_time" jdbcType="VARCHAR" property="onDutyTime" />
    <result column="off_duty_time" jdbcType="VARCHAR" property="offDutyTime" />
    <result column="morrow_duty_time_flag" jdbcType="VARCHAR" property="morrowDutyTimeFlag" />
    <result column="rest_time" jdbcType="VARCHAR" property="restTime" />
    <result column="rest_days" jdbcType="VARCHAR" property="restDays" />
    <result column="festival_rest_flag" jdbcType="VARCHAR" property="festivalRestFlag" />
    <result column="sign_in_rule" jdbcType="VARCHAR" property="signInRule" />
    <result column="sign_out_rule" jdbcType="VARCHAR" property="signOutRule" />
    <result column="on_punch_card_time" jdbcType="VARCHAR" property="onPunchCardTime" />
    <result column="off_punch_card_time" jdbcType="VARCHAR" property="offPunchCardTime" />
    <result column="auto_classes_flag" jdbcType="VARCHAR" property="autoClassesFlag" />
    <result column="create_time" jdbcType="VARCHAR" property="createTime" />
  </resultMap>
  <resultMap id="ApplicationMap" type="com.xiangshangban.att_simple.bean.Application">
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="employee_id" jdbcType="VARCHAR" property="employeeId" />
    <result column="company_id" jdbcType="VARCHAR" property="companyId" />
    <result column="start_time" jdbcType="VARCHAR" property="startTime" />
    <result column="end_time" jdbcType="VARCHAR" property="endTime" />
    <result column="is_skip_rest_day" jdbcType="VARCHAR" property="isSkipRestDay" />
    <result column="applicaiton_type" jdbcType="VARCHAR" property="applicaitonType"/>
    <result column="applicaiton_children_type" property="applicaitonChildrenType"/>
  </resultMap>
  <select id="getPlanByDate" resultMap="ClassesEmployee">
  	select a.emp_id, a.emp_company_id, a.classes_id, a.on_duty_scheduling_date,
  		 a.off_duty_scheduling_date,a.rest_start_time, a.rest_end_time, a.week,
  		 a.sign_in_rule, a.sign_out_rule, a.on_punch_card_time, a.off_punch_card_time
	FROM classes_employee_ AS a
	WHERE a.company_id=#{companyId} AND a.emp_id=#{employeeId} AND a.on_duty_scheduling_date::DATE=#{countDate}::DATE
  </select>
  <select id="getMinSignIn" resultType="String">
  	SELECT min(record_date) 
	FROM(
		SELECT a.record_date
		FROM device.door_record AS a
		LEFT JOIN device.door_ AS b ON a.door_id=b.door_id
		WHERE a.employee_id=#{employeeId} AND b.company_id=#{companyId}
		 AND (a.record_date BETWEEN #{beginTime} AND #{endTime})
		 AND (a.record_type='2' OR a.record_type='3' OR a.record_type='6' OR a.record_type='7' OR a.record_type='8')
	  UNION
		SELECT a.fill_card_time AS record_date
		FROM application_fill_card_ b
		WHERE b.employee_id=#{employeeId} AND b.company_id=#{companyId}
	   AND (b.fill_card_time BETWEEN #{beginTime} AND #{endTime})
	) AS c 
  </select>
  <select id="getMaxSignOut" resultType="String">
  	SELECT max(record_date) 
	FROM(
		SELECT a.record_date
		FROM device.door_record AS a
		LEFT JOIN device.door_ AS b ON a.door_id=b.door_id
		WHERE a.employee_id=#{employeeId} AND b.company_id=#{companyId}
		 AND (a.record_date BETWEEN #{beginTime} AND #{endTime})
		 AND (a.record_type='2' OR a.record_type='3' OR a.record_type='6' OR a.record_type='7' OR a.record_type='8')
	  UNION
		SELECT a.fill_card_time AS record_date
		FROM application_fill_card_ b
		LEFT JOIN application_total_record_ AS c ON b.application_id=c.application_no
		WHERE b.employee_id=#{employeeId} AND b.company_id=#{companyId} 
		AND  c.is_complete='1' AND c.is_reject='0'
	   AND (b.fill_card_time BETWEEN #{beginTime} AND #{endTime})
	) AS c 
  </select>
  <select id="getLeaveByTime" resultMap="ApplicationMap">
  	SELECT DISTINCT a.start_time,a.end_time,a.employee_id,
  			a.department_id,a.company_id, '1' AS application_type,
  			leave_type AS applicaiton_children_type
	FROM application_leave_ a
	LEFT JOIN application_total_record_ AS b ON a.application_id=b.application_no
	WHERE a.employee_id=#{employeeId} AND a.company_id=#{companyId} 
	AND  b.is_complete='1' AND b.is_reject='0'
	AND ((#{endTime} BETWEEN a.start_time AND a.end_time)
			OR (a.end_time BETWEEN #{beginTime} AND #{endTime}))
	ORDER BY a.start_time
  </select>
  <select id="getOutByTime" resultMap="ApplicationMap">
  	SELECT DISTINCT a.start_time,a.end_time,a.employee_id,
  		a.department_id,a.company_id, b.is_skip_rest_day, '4' AS application_type
	FROM application_outgoing_ a
	LEFT JOIN application_total_record_ AS b ON a.application_id=b.application_no
	WHERE a.employee_id=#{employeeId} AND a.company_id=#{companyId} 
	AND  b.is_complete='1' AND b.is_reject='0'
	AND ((#{endTime} BETWEEN a.start_time AND a.end_time)
			OR (a.end_time BETWEEN #{beginTime} AND #{endTime}))
	ORDER BY a.start_time
  </select>
    <select id="getBusinessByTime" resultMap="ApplicationMap">
  	SELECT DISTINCT a.start_time,a.end_time,a.employee_id,
  		a.department_id,a.company_id, b.is_skip_rest_day, '3' AS application_type
	FROM application_business_travel_ a
	LEFT JOIN application_total_record_ AS b ON a.application_id=b.application_no
	WHERE a.employee_id=#{employeeId} AND a.company_id=#{companyId} 
	AND  b.is_complete='1' AND b.is_reject='0'
	AND ((#{endTime} BETWEEN a.start_time AND a.end_time)
			OR (a.end_time BETWEEN #{beginTime} AND #{endTime}))
	ORDER BY a.start_time
  </select>
  <select id="getOverByTime"  resultMap="ApplicationMap">
  	SELECT DISTINCT a.start_time,a.end_time,a.employee_id,
  		a.department_id,a.company_id, '2' AS application_type
	FROM application_overtime_ a
	WHERE a.employee_id=#{employeeId} AND a.company_id=#{companyId}
	AND a.start_time::date=#{beginTime}::date
	ORDER BY a.start_time
  </select>
  <select id="getIsCheck" resultType="int">
  	SELECT count(id) 
	FROM not_clocking_in_emp
	WHERE emp_id=#{employeeId} AND emp_company_id= #{companyId}
  </select>
  <select id="getVacationId" resultType="String">
  	SELECT vacation_id 
	FROM vacation
	WHERE employee_id=#{employeeId} 
		AND company_id=#{companyId} AND year_=to_char(#{attDate}::TIMESTAMP, 'yyyy') 
  </select>
</mapper>